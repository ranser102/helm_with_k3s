pipeline {
    environment {
        registry = "eransery/py_k8s"
        registryCredential = 'erandockerhub'
    }
    agent any

    stages {
        stage('Hello') {
            steps {
                echo 'Hello World'
            }
        }
        stage('Building image') {
            steps{
                script {
                    dockerImage = docker.build registry + ":$BUILD_NUMBER"
                }
            }
        }
        stage('Push image to hub.docker.io') { 
            steps { 
                script { 
                    docker.withRegistry( '', registryCredential ) { 
                        dockerImage.push() 
                    }
                } 
            }
        } 
        stage('Cleaning up') { 
            steps { 
                sh "docker rmi $registry:$BUILD_NUMBER" 
            }
        }        
        stage('Check k8s info') {
            steps {
                sh "kubectl cluster-info"
            }
        }
        stage('create namespcae') {
            steps {
                script {
                    namespace = 'eransery'
                    echo "Creating namespace ${namespace} if needed"
                    sh "[ ! -z \"\$(kubectl get ns ${namespace} -o name 2>/dev/null)\" ] || kubectl create ns ${namespace}"
                }
            }
        }         
        stage('Delete app using helm ') {
            steps {
                script {
                    namespace = 'eransery'
                    release = 'pod_cox_sery'
                    echo "Deleting ${release} in ${namespace} if deployed"
                    sh "[ -z \"\$(helm ls --short ${release} 2>/dev/null)\" ] || helm delete --purge ${release}"
                }
            }
        }        
        stage('Install app using helm chart') {
            steps {
                script {
                    namespace = 'eransery'
                    release = 'pod_cox_sery'
                    echo "Installing ${release} in ${namespace}"
                    
                    sh """
                        helm upgrade --install --namespace ${namespace} ${release} 
                    """
                    sh "sleep 5"
                }
            }
        }        
    }
}
